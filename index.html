<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

        <!-- Bootstrap CSS -->
        <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous"
        />

        <title>Hello, world!</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- Import Mapbox GL JS -->
        <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>
        <link
            href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css"
            rel="stylesheet"
        />

        <!-- Import Mapbox GL Directions -->
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js"></script>
        <link
            rel="stylesheet"
            href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css"
            type="text/css"
        />

        <!-- Import Turf & Polyline -->
        <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-polyline/1.1.1/polyline.js"></script>

        <style>
            body {
                margin: 0;
                padding: 0;
                font-family: "Open Sans", sans-serif;
            }

            #map {
                position: absolute;
                top: 30;
                bottom: 0;
                width: 100%;
                height:85%;
            }

            .card {
                font-size: small;
                border-bottom: solid #d3d3d3 2px;
                margin-bottom: 6px;
            }

            .card-header {
                font-weight: bold;
                padding: 6px;
            }

            .no-route {
                background-color: #d3d3d3;
                color: #f00;
            }

            .obstacle-found {
                background-color: #d3d3d3;
                color: #fff;
            }

            .route-found {
                background-color: #33a532;
                color: #fff;
            }

            .card-details {
                padding: 3px 6px;
            }
            .truck {
                width: 20px;
                height: 20px;
                border: 2px solid #0000;
                border-radius: 50%;
                background: green;
                pointer-events: none;
            }
        </style>
    </head>

    <body>
        <div>Your Route is:</div>
        <div id="map"></div>
        <script
            src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        
        <script>
            const truckLocation = [72.842812, 19.21558];
             const warehouseLocation = [
                [72.845812, 19.21568],
                [72.855673, 19.24558],
                [72.852912, 19.25558],
            ];
            //const warehouseLocation = [72.855673,19.184196];
            const lastAtRestaurant = 0;
            
            const pointHopper = {};

            // Add your access token
            mapboxgl.accessToken =
                "pk.eyJ1IjoiYmhhdnlhMDkyIiwiYSI6ImNrb2xlNWUzbjFiNjAydnE0bXpsbG13MGcifQ.jik4Q9NnhmABl1qhYKt7ZA";

            // Initialize a map
            const map = new mapboxgl.Map({
                container: "map", // container id
                style: "mapbox://styles/mapbox/streets-v11", // stylesheet location
                center: truckLocation, // starting position
                zoom: 12, // starting zoom

            });

             const directions = new MapboxDirections({
                accessToken: mapboxgl.accessToken,
                unit: "metric",
                steps: true,
                geometries: "polyline",
                alternatives: true,
                controls: { instructions: true, profileSwitcher: false },
                congestion: true,
                voice_instructions:true,
                roundtrip:true,
               // waypoints:'72.842812,19.21558;72.845812,19.21568;72.855673,19.24558;72.852912,19.25558;72.842812,19.21558'
            });
            map.addControl(directions, 'top-right');

            const warehouse = turf.featureCollection([turf.multiPoint(warehouseLocation)]);
            const dropoffs = turf.featureCollection([]);
            const nothing = turf.featureCollection([]);

            map.on("load", async () => {
                const marker = document.createElement("div");
                marker.classList = "truck";
                new mapboxgl.Marker(marker).setLngLat(truckLocation).addTo(map);
                map.addLayer({
                    id: "warehouse",
                    type: "circle",
                    source: {
                        data: warehouse,
                        type: "geojson",
                    },
                    paint: {
                        "circle-radius": 10,
                        "circle-color": "white",
                        "circle-stroke-color": "#FF0000",
                        "circle-stroke-width": 3,
                    },
                });
                map.addLayer({
                    id: "warehouse-symbol",
                    type: "symbol",
                    source: {
                        data: warehouse,
                        type: "geojson",
                    },
                    layout: {
                        "icon-image": "grocery-15",
                        "icon-size": 1,
                    },
                    paint: {
                        "text-color": "#3887be",
                    },
                });
                

                map.addSource("route", {
                    type: "geojson",
                    data: nothing,
                });

                map.addLayer(
                    {
                        id: "routeline-active",
                        type: "line",
                        source: "route",
                        layout: {
                            "line-join": "round",
                            "line-cap": "round",
                        },
                        paint: {
                            "line-color": "#3887be",
                            "line-width": ["interpolate", ["linear"], ["zoom"], 12, 3, 22, 12],
                        },
                    },
                    "natural-line-label"
                );

                map.addLayer(
                    {
                        id: "routearrows",
                        type: "symbol",
                        source: "route",
                        layout: {
                            "symbol-placement": "line",
                            "text-field": "â–¶",
                            "text-size": ["interpolate", ["linear"], ["zoom"], 12, 24, 22, 60],
                            "symbol-spacing": [
                                "interpolate",
                                ["linear"],
                                ["zoom"],
                                12,
                                30,
                                22,
                                160,
                            ],
                            "text-keep-upright": false,
                        },
                        paint: {
                            "text-color": "#3887be",
                            "text-halo-color": "hsl(55, 11%, 96%)",
                            "text-halo-width": 1,
                        },
                    },
                    "natural-line-label"
                );
                
                newDropoff();
            });


            async function newDropoff(

            ) {
                const query = await fetch(assembleQueryURL(), { method: "GET" });
                const { code, message, trips, waypoints } = await query.json();
                console.log(code);
                console.log(trips);

                // Create an alert for any requests that return an error
                if (code !== "Ok") {
                    const handleMessage =
                        code === "InvalidInput"
                            ? "Refresh to start a new route. For more information: https://docs.mapbox.com/api/navigation/optimization/#optimization-api-errors"
                            : "Try a different point.";
                    alert(`${code} - ${message}\n\n${handleMessage}`);
                    // Remove invalid point
                    dropoffs.features.pop();
                    delete pointHopper[pt.properties.key];
                    return;
                }

                // Create a GeoJSON feature collection
                const routeGeoJSON = turf.featureCollection([turf.feature(trips[0].geometry)]);
                map.getSource("route").setData(routeGeoJSON);
            }

           
            function assembleQueryURL() {
                const coordinates = [truckLocation,...warehouseLocation];
                const distributions=[]
                
                console.log(
                    `https://api.mapbox.com/optimized-trips/v1/mapbox/driving/${coordinates.join(
                        ";"
                    )}?distributions=${distributions.join(
                        ";"
                    )}&overview=full&steps=true&geometries=geojson&source=first&access_token=${
                        mapboxgl.accessToken
                    }`
                );
                
                return `https://api.mapbox.com/optimized-trips/v1/mapbox/driving-traffic/${coordinates.join(
                    ";"
                )}?distributions=${distributions.join(
                    ";"
                )}&overview=full&steps=true&geometries=geojson&source=first&roundtrip=true&access_token=${
                    mapboxgl.accessToken
                }`;
            }
        </script>
    </body>
</html>
